@model MyApp.Models.Auction
@{
    var auctionId = (int)ViewData["AuctionId"];
}
<h2 class="text-center">Chi tiết phiên đấu giá</h2>
    <div class="card">
    <div class="card-body">
     <div class="row">
        <div class="col-md-6 text-center"><img class="img-fluid rounded float-start" src="@Model.ImgUrl" alt="Ảnh sản phẩm @Model.Name" class="img-fluid mb-3" style="max-height: 300px;" /></div>
        <div class="col-md-6">
            <div class="row"><p><strong>Tên sản phẩm: </strong>@Model.Name</p></div>
            <div class="row"><p><strong>Giới thiệu sản phẩm: </strong> @Model.Description</p></div>
            <div class="row"><p><strong>Thời gian kết thúc:</strong> @Model.TimeEnd.ToString("dd/MM/yyyy HH:mm")</p></div>
            <div class="row"><p><strong>Price Start: </strong>@Model.PriceStart.ToString("N0") VNĐ</p></div>
            <div class="row"><p><strong>Giá cao nhất hiện tại:</strong> <span id="highestBid" class="text-danger">@ViewBag.HighestBid.ToString("N0") VNĐ</span></p></div>
            
        </div>
    </div>
<form asp-controller="Bid" asp-action="PlaceBid" method="post" id="bidForm">
    @Html.AntiForgeryToken()
    <input type="hidden" name="auctionId" value="@Model.Id" />
    <div class="form-group">
        <label for="bidAmount">Nhập giá của bạn:</label>
        <input type="number" name="bidAmount" class="form-control" required />
    </div>
    <button type="submit" class="btn btn-primary mt-2 text-center">Đặt giá</button>
</form>

    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>

<script>
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/auctionHub")
        .build();

    connection.on("ReceiveHighestBid", function (auctionId, price) {
        if (auctionId === @Model.Id) {
            document.getElementById("highestBid").innerText = price.toLocaleString('vi-VN') + " VNĐ";
        }
    });
    connection.start().catch(function (err) {
        console.error(err.toString());
    });
    document.getElementById("bidForm").addEventListener("submit", function (event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        fetch(form.action, {
            method: "POST",
            body: formData,
            headers: {
                "RequestVerificationToken": formData.get("__RequestVerificationToken")
            }
        })
        .then(response => {
            if (response.ok) {
                alert("Đặt giá thành công!");
                form.reset();
            } else {
                return response.text().then(text => { throw new Error(text); });
            }
        })
        .catch(error => {
            alert("Lỗi khi đặt giá: " + error.message);
        });
    });
    
</script>
