@model IEnumerable<Auction>
@{
    ViewData["Title"] = "Phiên Đấu Giá Của Tôi";
}

<div class="container">
    <!-- Page Header -->
    <div class="page-header mb-5">
        <h1 class="page-title">
            <i class="fas fa-gavel me-2"></i>
            @ViewData["Title"]
        </h1>
        <p class="page-subtitle text-muted">Quản lý tất cả phiên đấu giá bạn đã tạo</p>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Tổng Phiên
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.Count()</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-list fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Đang Diễn Ra
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                @Model.Count(a => a.Status == AuctionStatus.Approved && a.TimeStart <= DateTime.Now && a.TimeEnd >= DateTime.Now)
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-play-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Chờ Duyệt
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                @Model.Count(a => a.Status == AuctionStatus.Pending)
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Tổng Lượt Đấu
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                @Model.Sum(a => a.Bids.Count)
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-hammer fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions Bar -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h5 class="card-title mb-0">Quản lý phiên đấu giá</h5>
                </div>
                <div class="col-md-4 text-end">
                    <a asp-controller="Auction" asp-action="Create" class="btn btn-primary">
                        <i class="fas fa-plus-circle me-2"></i>Tạo Phiên Mới
                    </a>
                </div>
            </div>
        </div>
    </div>

    @if (!Model.Any())
    {
        <!-- Empty State -->
        <div class="card shadow-sm">
            <div class="card-body text-center py-5">
                <i class="fas fa-gavel fa-4x text-muted mb-4"></i>
                <h3 class="text-muted">Chưa có phiên đấu giá nào</h3>
                <p class="text-muted mb-4">Bạn chưa tạo phiên đấu giá nào. Hãy bắt đầu bằng cách tạo phiên đầu tiên!</p>
                <a asp-controller="Auction" asp-action="Create" class="btn btn-primary btn-lg">
                    <i class="fas fa-plus-circle me-2"></i>Tạo Phiên Đấu Giá Đầu Tiên
                </a>
            </div>
        </div>
    }
    else
    {
        <!-- Tabs Navigation -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white">
                <ul class="nav nav-tabs card-header-tabs" id="auctionTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button" role="tab">
                            Tất Cả (@Model.Count())
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="active-tab" data-bs-toggle="tab" data-bs-target="#active" type="button" role="tab">
                            Đang Diễn Ra (@Model.Count(a => a.Status == AuctionStatus.Approved && a.TimeStart <= DateTime.Now && a.TimeEnd >= DateTime.Now))
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button" role="tab">
                            Chờ Duyệt (@Model.Count(a => a.Status == AuctionStatus.Pending))
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="closed-tab" data-bs-toggle="tab" data-bs-target="#closed" type="button" role="tab">
                            Đã Kết Thúc (@Model.Count(a => a.Status == AuctionStatus.Closed || (a.Status == AuctionStatus.Approved && a.TimeEnd < DateTime.Now)))
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="rejected-tab" data-bs-toggle="tab" data-bs-target="#rejected" type="button" role="tab">
                            Bị Từ Chối (@Model.Count(a => a.Status == AuctionStatus.Rejected))
                        </button>
                    </li>
                </ul>
            </div>

            <div class="card-body">
                <div class="tab-content" id="auctionTabsContent">
                    <!-- All Auctions Tab -->
                    <div class="tab-pane fade show active" id="all" role="tabpanel">
                        <div class="row">
                            @foreach (var auction in Model)
                            {
                                <div class="col-xl-4 col-lg-6 col-md-6 mb-4">
                                    @await Html.PartialAsync("_AuctionCard", auction)
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Active Auctions Tab -->
                    <div class="tab-pane fade" id="active" role="tabpanel">
                        <div class="row">
                            @foreach (var auction in Model.Where(a => a.Status == AuctionStatus.Approved && a.TimeStart <= DateTime.Now && a.TimeEnd >= DateTime.Now))
                            {
                                <div class="col-xl-4 col-lg-6 col-md-6 mb-4">
                                    @await Html.PartialAsync("_AuctionCard", auction)
                                </div>
                            }
                            @if (!Model.Any(a => a.Status == AuctionStatus.Approved && a.TimeStart <= DateTime.Now && a.TimeEnd >= DateTime.Now))
                            {
                                <div class="col-12 text-center py-5">
                                    <i class="fas fa-play-circle fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">Không có phiên đang diễn ra</h5>
                                    <p class="text-muted">Hiện tại không có phiên đấu giá nào đang diễn ra.</p>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Pending Auctions Tab -->
                    <div class="tab-pane fade" id="pending" role="tabpanel">
                        <div class="row">
                            @foreach (var auction in Model.Where(a => a.Status == AuctionStatus.Pending))
                            {
                                <div class="col-xl-4 col-lg-6 col-md-6 mb-4">
                                    @await Html.PartialAsync("_AuctionCard", auction)
                                </div>
                            }
                            @if (!Model.Any(a => a.Status == AuctionStatus.Pending))
                            {
                                <div class="col-12 text-center py-5">
                                    <i class="fas fa-clock fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">Không có phiên chờ duyệt</h5>
                                    <p class="text-muted">Tất cả phiên đấu giá của bạn đã được duyệt hoặc không có phiên nào đang chờ.</p>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Closed Auctions Tab -->
                    <div class="tab-pane fade" id="closed" role="tabpanel">
                        <div class="row">
                            @foreach (var auction in Model.Where(a => a.Status == AuctionStatus.Closed || (a.Status == AuctionStatus.Approved && a.TimeEnd < DateTime.Now)))
                            {
                                <div class="col-xl-4 col-lg-6 col-md-6 mb-4">
                                    @await Html.PartialAsync("_AuctionCard", auction)
                                </div>
                            }
                            @if (!Model.Any(a => a.Status == AuctionStatus.Closed || (a.Status == AuctionStatus.Approved && a.TimeEnd < DateTime.Now)))
                            {
                                <div class="col-12 text-center py-5">
                                    <i class="fas fa-flag-checkered fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">Không có phiên đã kết thúc</h5>
                                    <p class="text-muted">Chưa có phiên đấu giá nào kết thúc.</p>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Rejected Auctions Tab -->
                    <div class="tab-pane fade" id="rejected" role="tabpanel">
                        <div class="row">
                            @foreach (var auction in Model.Where(a => a.Status == AuctionStatus.Rejected))
                            {
                                <div class="col-xl-4 col-lg-6 col-md-6 mb-4">
                                    @await Html.PartialAsync("_AuctionCard", auction)
                                </div>
                            }
                            @if (!Model.Any(a => a.Status == AuctionStatus.Rejected))
                            {
                                <div class="col-12 text-center py-5">
                                    <i class="fas fa-times-circle fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">Không có phiên bị từ chối</h5>
                                    <p class="text-muted">Tất cả phiên đấu giá của bạn đã được phê duyệt.</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteAuctionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>Xóa Phiên Đấu Giá
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc muốn xóa phiên đấu giá "<span id="deleteAuctionName"></span>"?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Lưu ý:</strong> Hành động này không thể hoàn tác. Tất cả thông tin về phiên đấu giá và lịch sử đấu giá sẽ bị xóa vĩnh viễn.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteAuction">
                    <i class="fas fa-trash me-2"></i>Xóa Phiên
                </button>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .page-header {
            border-bottom: 2px solid #f8f9fa;
            padding-bottom: 1.5rem;
        }

        .page-title {
            font-weight: 700;
            color: #2c3e50;
        }

        .card {
            border: none;
            border-radius: 15px;
        }

        .nav-tabs .nav-link {
            border: none;
            color: #6c757d;
            font-weight: 500;
            padding: 1rem 1.5rem;
            border-radius: 0;
        }

            .nav-tabs .nav-link.active {
                color: #3498db;
                border-bottom: 3px solid #3498db;
                background: transparent;
            }

            .nav-tabs .nav-link:hover {
                color: #3498db;
                border-bottom: 3px solid #e9ecef;
            }

        .border-left-primary {
            border-left: 0.25rem solid #4e73df !important;
        }

        .border-left-success {
            border-left: 0.25rem solid #1cc88a !important;
        }

        .border-left-warning {
            border-left: 0.25rem solid #f6c23e !important;
        }

        .border-left-info {
            border-left: 0.25rem solid #36b9cc !important;
        }

        .btn {
            border-radius: 10px;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
        }

        .tab-content {
            min-height: 400px;
        }

        @@media (max-width: 768px) {
            .nav-tabs .nav-link {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }

            .card-body {
                padding: 1rem;
            }
        }
    </style>
}

@section Scripts {
    <script>
        $(document).ready(function() {
            // Initialize tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Tab persistence
            $('button[data-bs-toggle="tab"]').on('click', function() {
                localStorage.setItem('activeAuctionTab', $(this).attr('id'));
            });

            var activeTab = localStorage.getItem('activeAuctionTab');
            if (activeTab) {
                $('#' + activeTab).tab('show');
            }

            // Auto-refresh active auctions every 30 seconds
            setInterval(function() {
                if ($('#active-tab').hasClass('active')) {
                    location.reload();
                }
            }, 30000);

            // Delete auction functionality
            $('.delete-auction-btn').click(function() {
                var auctionId = $(this).data('auction-id');
                var auctionName = $(this).data('auction-name');

                $('#deleteAuctionName').text(auctionName);
                $('#confirmDeleteAuction').data('auction-id', auctionId);
                $('#deleteAuctionModal').modal('show');
            });

            $('#confirmDeleteAuction').click(function() {
                var auctionId = $(this).data('auction-id');

                $.ajax({
                    url: '@Url.Action("DeleteAuction", "Auction")',
                    type: 'POST',
                    data: { id: auctionId },
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            showToast('success', response.message);
                            $('#deleteAuctionModal').modal('hide');
                            // Remove auction card from view
                            $('.auction-card[data-auction-id="' + auctionId + '"]').fadeOut(300, function() {
                                $(this).remove();
                                updateStatistics();
                            });
                        } else {
                            showToast('error', response.message);
                            $('#deleteAuctionModal').modal('hide');
                        }
                    },
                    error: function() {
                        showToast('error', 'Đã xảy ra lỗi khi xóa phiên đấu giá.');
                        $('#deleteAuctionModal').modal('hide');
                    }
                });
            });

            function updateStatistics() {
                // Update statistics cards
                var totalAuctions = $('.auction-card').length;
                var activeAuctions = $('.auction-card .badge.bg-success').length;
                var pendingAuctions = $('.auction-card .badge.bg-warning').length;

                $('.card-border-left-primary .h5').text(totalAuctions);
                $('.card-border-left-success .h5').text(activeAuctions);
                $('.card-border-left-warning .h5').text(pendingAuctions);

                // Update tab counts
                $('#all-tab').text('Tất Cả (' + totalAuctions + ')');
                $('#active-tab').text('Đang Diễn Ra (' + activeAuctions + ')');
                $('#pending-tab').text('Chờ Duyệt (' + pendingAuctions + ')');
            }

            function showToast(type, message) {
                var toast = `<div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0" role="alert">
                                <div class="d-flex">
                                    <div class="toast-body">${message}</div>
                                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                                </div>
                             </div>`;
                $('.toast-container').append(toast);
                $('.toast').last().toast('show');
                setTimeout(() => {
                    $('.toast').last().toast('hide');
                    setTimeout(() => $('.toast').last().remove(), 500);
                }, 5000);
            }
        });
    </script>
}